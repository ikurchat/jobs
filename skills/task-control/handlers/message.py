"""Response formatters for Telegram messages.

All functions return formatted text strings ready for tg_send_message.
"""

from __future__ import annotations

from typing import Any

# Circled digit mapping for task numbering
CIRCLED_DIGITS = {
    1: "â‘ ", 2: "â‘¡", 3: "â‘¢", 4: "â‘£", 5: "â‘¤",
    6: "â‘¥", 7: "â‘¦", 8: "â‘§", 9: "â‘¨", 10: "â‘©",
    11: "â‘ª", 12: "â‘«", 13: "â‘¬", 14: "â‘­", 15: "â‘®",
}


def _circled(n: int) -> str:
    return CIRCLED_DIGITS.get(n, f"({n})")


def _get_val(field: Any) -> str:
    if isinstance(field, dict):
        return field.get("value", "")
    return str(field) if field else ""


def _get_link(field: Any) -> str:
    if isinstance(field, list) and field:
        return ", ".join(
            item.get("value", str(item)) if isinstance(item, dict) else str(item)
            for item in field
        )
    if isinstance(field, dict):
        return field.get("value", str(field))
    return str(field) if field else ""


def format_briefing(briefing_text: str) -> str:
    """Wrap briefing text (already generated by scheduler) for sending."""
    return briefing_text


def format_task_draft(tasks: list[dict], shifts_info: list[dict] | None = None) -> str:
    """Format parsed tasks as a draft for owner confirmation.

    tasks = [{title, task_type, assignee_fio, assignee_hint, priority, ...}]
    shifts_info = [{employee, shift_type, active_tasks}]
    """
    if not tasks:
        return "Ð—Ð°Ð´Ð°Ñ‡ Ð½Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¾."

    # Group by type
    groups: dict[str, list[tuple[int, dict]]] = {}
    type_labels = {
        "delegate": "Ð”Ð•Ð›Ð•Ð“Ð˜Ð ÐžÐ’ÐÐÐ˜Ð•",
        "collab": "Ð¡ÐžÐ’ÐœÐ•Ð¡Ð¢ÐÐÐ¯ Ð ÐÐ‘ÐžÐ¢Ð (Ñ‚Ñ‹ + Ð±Ð¾Ñ‚)",
        "inform": "Ð˜ÐÐ¤ÐžÐ ÐœÐ˜Ð ÐžÐ’ÐÐÐ˜Ð•",
        "boss_control": "ÐÐ ÐšÐžÐÐ¢Ð ÐžÐ›Ð• Ð£ Ð Ð£ÐšÐžÐ’ÐžÐ”Ð¡Ð¢Ð’Ð",
        "report_up": "Ð”ÐžÐšÐ›ÐÐ” Ð Ð£ÐšÐžÐ’ÐžÐ”Ð¡Ð¢Ð’Ð£",
        "regulatory": "Ð Ð•Ð“Ð£Ð›Ð¯Ð¢ÐžÐ ÐÐ«Ð•",
        "skill_update": "ÐŸÐ ÐÐ’ÐšÐ˜ Ð¡ÐšÐ˜Ð›Ð›ÐžÐ’",
        "personal": "Ð›Ð˜Ð§ÐÐ«Ð•",
        "backlog": "Ð‘Ð­ÐšÐ›ÐžÐ“",
    }

    for i, t in enumerate(tasks, 1):
        ttype = t.get("task_type", "delegate")
        groups.setdefault(ttype, []).append((i, t))

    lines = [f"Ð Ð°Ð·Ð¾Ð±Ñ€Ð°Ð» {len(tasks)} Ð·Ð°Ð´Ð°Ñ‡:\n"]

    # Build shift lookup for quick info
    shift_lookup: dict[str, dict] = {}
    if shifts_info:
        for s in shifts_info:
            emp = s.get("employee", "")
            shift_lookup[str(emp)] = s

    # Questions to ask
    questions = []

    for ttype in ["delegate", "collab", "inform", "boss_control", "report_up",
                   "regulatory", "skill_update", "personal", "backlog"]:
        items = groups.get(ttype, [])
        if not items:
            continue

        label = type_labels.get(ttype, ttype.upper())
        lines.append(f"{label}:")

        for num, task in items:
            title = task.get("title", "?")
            assignee = task.get("assignee_fio", task.get("assignee_hint", ""))
            deadline = task.get("deadline", "")

            # Build line
            parts = [f"{_circled(num)} {title}"]
            if assignee:
                parts.append(f"â†’ {assignee}")
            if deadline:
                parts.append(f"Ð´Ð¾ {deadline}")

            # Missing info markers
            missing = []
            if ttype == "delegate" and not assignee:
                missing.append("ÐºÐ¾Ð¼Ñƒ?")
            if not deadline and ttype not in ("backlog", "skill_update"):
                missing.append("ÑÑ€Ð¾Ðº?")
            if ttype == "delegate" and not task.get("delivery_method"):
                missing.append("Ñ‡ÐµÑ€ÐµÐ· Ñ‡Ñ‚Ð¾ ÑÑ‚Ð°Ð²Ð¸Ð¼?")

            if missing:
                parts.append(" | ".join(missing))

            lines.append("  " + " | ".join(parts))

            # Shift/load info for assignee
            if assignee and assignee in shift_lookup:
                si = shift_lookup[assignee]
                stype = si.get("shift_type", "")
                active = si.get("active_tasks", 0)
                schedule = si.get("schedule_type", "")
                if stype:
                    lines.append(f"    âš¡ {assignee} â€” {stype}, Ð·Ð°Ð´Ð°Ñ‡: {active}")
                elif schedule:
                    lines.append(f"    ðŸ“… {assignee} â€” {schedule}, Ð·Ð°Ð´Ð°Ñ‡: {active}")

            # Collect questions
            if missing:
                questions.append((num, missing))

        lines.append("")

    # Questions summary
    if questions:
        lines.append("Ð£Ñ‚Ð¾Ñ‡Ð½Ð¸:")
        for num, missing in questions:
            lines.append(f"- {_circled(num)}: {', '.join(missing)}")

    return "\n".join(lines).strip()


def format_task_list(tasks: list[dict], title: str = "Ð—Ð°Ð´Ð°Ñ‡Ð¸") -> str:
    """Format a list of tasks with statuses."""
    if not tasks:
        return f"{title}: Ð¿ÑƒÑÑ‚Ð¾."

    status_icons = {
        "draft": "ðŸ“",
        "assigned": "ðŸ“‹",
        "in_progress": "ðŸ”„",
        "done": "âœ…",
        "overdue": "ðŸ”´",
        "cancelled": "âŒ",
        "handed_over": "ðŸ”",
        "waiting_input": "â³",
    }

    lines = [f"{title} ({len(tasks)}):", ""]
    for i, t in enumerate(tasks, 1):
        status = _get_val(t.get("status", ""))
        icon = status_icons.get(status, "â€¢")
        title_text = t.get("title", "?")
        assignee = _get_link(t.get("assignee", ""))
        deadline = t.get("deadline", "")

        line = f"{icon} {title_text}"
        if assignee:
            line += f" | {assignee}"
        if deadline:
            line += f" | Ð´Ð¾ {str(deadline)[:10]}"
        lines.append(line)

    return "\n".join(lines)


def format_handover(handover_text: str) -> str:
    """Wrap handover push text."""
    return handover_text


def format_anomaly_alert(anomalies: list[dict]) -> str:
    """Format anomaly alerts."""
    if not anomalies:
        return ""

    lines = ["âš ï¸ ÐÐÐžÐœÐÐ›Ð˜Ð˜:", ""]
    for a in anomalies:
        atype = a.get("type", "")
        emp = a.get("employee", a.get("task", ""))
        detail = a.get("detail", "")

        type_labels = {
            "overload": "ÐŸÐµÑ€ÐµÐ³Ñ€ÑƒÐ·",
            "idle": "ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹",
            "chronic_overdue": "Ð¥Ñ€Ð¾Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐºÐ¸",
            "performance_drop": "ÐŸÐ°Ð´ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÐµÐ¹",
            "shift_imbalance": "Ð”Ð¸ÑÐ±Ð°Ð»Ð°Ð½Ñ ÑÐ¼ÐµÐ½",
            "stale_task": "Ð—Ð°Ð²Ð¸ÑÑˆÐ°Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°",
        }
        label = type_labels.get(atype, atype)
        lines.append(f"â€¢ {label}: {emp} â€” {detail}")

    lines.append("")
    lines.append("ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ?")
    return "\n".join(lines)


def format_weekly_report_summary(summary: dict) -> str:
    """Format weekly report summary (text version)."""
    total = summary.get("total", 0)
    completed = summary.get("completed", 0)
    overdue = summary.get("overdue", 0)
    in_progress = summary.get("in_progress", 0)

    lines = [
        f"ðŸ“Š Ð•Ð–Ð•ÐÐ•Ð”Ð•Ð›Ð¬ÐÐ«Ð™ ÐžÐ¢Ð§ÐÐ¢ ({summary.get('period_start', '')} â€” {summary.get('period_end', '')})",
        "",
        "ÐžÐ‘Ð©ÐÐ¯ Ð¡Ð¢ÐÐ¢Ð˜Ð¡Ð¢Ð˜ÐšÐ:",
        f"- ÐŸÐ¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¾: {total} | Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾: {completed} | ÐŸÑ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½Ð¾: {overdue} | Ð’ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ: {in_progress}",
        "",
    ]

    employees = summary.get("employees", [])
    if employees:
        lines.append("Ð˜Ð¡ÐŸÐžÐ›ÐÐ˜Ð¢Ð•Ð›Ð˜:")
        for i, emp in enumerate(employees, 1):
            fio = emp.get("fio", "?")
            t = emp.get("tasks_total", 0)
            rate = f"{emp.get('on_time_rate', 0):.0%}"
            marker = "âœ…" if emp.get("on_time_rate", 0) >= 0.9 else ("ðŸ”´" if emp.get("overdue_rate", 0) > 0.3 else "")
            lines.append(f"{i}. {fio} â€” {t} Ð·Ð°Ð´Ð°Ñ‡, {rate} Ð² ÑÑ€Ð¾Ðº {marker}")

    return "\n".join(lines)


def format_weekend_plan(plan_text: str) -> str:
    """Wrap weekend plan text."""
    return plan_text
